<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reserva de Turnos - Clínica Salud Integral</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="estilos.css" />
</head>

<body>
<header class="bg-primary text-white py-3 shadow-sm">
  <div class="container d-flex justify-content-between align-items-center">
    <h1 class="h4 m-0"><i class="fa-solid fa-calendar-plus me-2"></i>Reserva de Turnos</h1>
    <a href="index.html" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-house me-1"></i>Inicio</a>
  </div>
</header>

<main class="py-5">
  <div class="container">

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-primary mb-4">Complete los datos para reservar un turno</h5>
        
        <form id="formReserva">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Documento</label>
              <input type="text" id="documento" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellido y Nombre</label>
              <input type="text" id="apellidoNombre" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Especialidad</label>
              <select id="especialidad" class="form-select" required></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Médico</label>
              <select id="medico" class="form-select" required></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Obra Social</label>
              <select id="obraSocial" class="form-select" required></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Turno</label>
              <select id="turno" class="form-select" required></select>
            </div>
          </div>

          <div class="text-end mt-4">
            <button type="submit" class="btn btn-primary">
              <i class="fa-solid fa-check me-1"></i> Confirmar Reserva
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</main>

<footer class="bg-dark text-white text-center py-4 mt-5">
  <p class="m-0">&copy; 2025 Clínica Salud Integral. Todos los derechos reservados.</p>
</footer>

<script type="module">
  import { listarEspecialidades, obtenerEspecialidad } from './js/especialidades-storage.js';
  import { listarMedicos, obtenerMedico } from './js/medicos-storage.js';
  import { listarObrasSociales } from './js/obras-sociales-storage.js';
  import { listarTurnosDisponibles, obtenerTurno } from './js/turnos-storage.js';
  import { crearReserva } from './js/reservas-storage.js';
  import { calcularValorConDescuento } from './js/obras-sociales-storage.js';

  const formReserva = document.getElementById('formReserva');
  const selectEspecialidad = document.getElementById('especialidad');
  const selectMedico = document.getElementById('medico');
  const selectObraSocial = document.getElementById('obraSocial');
  const selectTurno = document.getElementById('turno');

  // Cargar especialidades
  function cargarEspecialidades() {
    const especialidades = listarEspecialidades();
    selectEspecialidad.innerHTML = '<option value="">Seleccione una especialidad</option>' +
      especialidades.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
  }

  // Cargar médicos según especialidad
  function cargarMedicos() {
    const especialidadId = selectEspecialidad.value;
    if (!especialidadId) {
      selectMedico.innerHTML = '<option value="">Seleccione una especialidad primero</option>';
      return;
    }
    const medicos = listarMedicos().filter(m => m.especialidadId == especialidadId);
    selectMedico.innerHTML = '<option value="">Seleccione un médico</option>' +
      medicos.map(m => `<option value="${m.id}">${m.apellido}, ${m.nombre}</option>`).join('');
  }

  // Cargar obras sociales
  function cargarObrasSociales() {
    const obras = listarObrasSociales();
    selectObraSocial.innerHTML = '<option value="">Seleccione una obra social</option>' +
      obras.map(o => `<option value="${o.id}">${o.nombre}</option>`).join('');
  }

  // Cargar turnos disponibles según médico
  function cargarTurnos() {
    const medicoId = selectMedico.value;
    if (!medicoId) {
      selectTurno.innerHTML = '<option value="">Seleccione un médico primero</option>';
      return;
    }
    const turnos = listarTurnosDisponibles().filter(t => t.medicoId == medicoId);
    selectTurno.innerHTML = turnos.length > 0
      ? '<option value="">Seleccione un turno</option>' + turnos.map(t => `
          <option value="${t.id}">
            ${new Date(t.fecha + 'T00:00').toLocaleDateString('es-AR')} - ${t.hora}
          </option>`).join('')
      : '<option value="">No hay turnos disponibles</option>';
  }

  // Eventos de selección
  selectEspecialidad.addEventListener('change', cargarMedicos);
  selectMedico.addEventListener('change', cargarTurnos);

  // Enviar formulario
  formReserva.addEventListener('submit', (e) => {
    e.preventDefault();

    const datos = {
      documento: document.getElementById('documento').value.trim(),
      apellidoNombre: document.getElementById('apellidoNombre').value.trim(),
      especialidadId: Number(selectEspecialidad.value),
      medicoId: Number(selectMedico.value),
      obraSocialId: Number(selectObraSocial.value),
      turnoId: Number(selectTurno.value)
    };

    try {
      const reserva = crearReserva(datos);

      // Disparar evento para actualizar el panel admin
      const event = new Event('nuevaReserva');
      window.dispatchEvent(event);

      alert(`✅ ¡Reserva confirmada!\n\nPaciente: ${reserva.apellidoNombre}\nEspecialidad: ${reserva.especialidadNombre}\nMédico: ${reserva.medicoNombre}\nFecha: ${new Date(reserva.fecha + 'T00:00').toLocaleDateString('es-AR')}\nHora: ${reserva.hora}\nValor a pagar: $${reserva.valorTotal.toFixed(2)}`);

      formReserva.reset();
      selectMedico.innerHTML = '<option value="">Seleccione una especialidad primero</option>';
      selectTurno.innerHTML = '<option value="">Seleccione un médico primero</option>';
      
    } catch (error) {
      alert('⚠️ Error al confirmar la reserva: ' + error.message);
    }
  });

  // Inicializar
  cargarEspecialidades();
  cargarObrasSociales();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
